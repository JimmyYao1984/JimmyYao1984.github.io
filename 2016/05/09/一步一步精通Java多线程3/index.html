<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Java多线程 0x03 | Jimmy的日记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="知识点
资源的并发访问控制
资源的多副本的并发访问控制
等待多个并发事件的完成
在集合点的同步
并发阶段任务的运行
并发阶段任务中的阶段切换
并发任务间的数据交换

介绍几个更高级的同步机制
信号量(Semaphore)：是一个计数器，用来保护一个或者多个共享资源的访问。
CountDownLatch：Java提供的同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许线程一直等待。
Cycl">
<meta property="og:type" content="article">
<meta property="og:title" content="Java多线程 0x03">
<meta property="og:url" content="http://JimmyYao984.github.io/2016/05/09/一步一步精通Java多线程3/index.html">
<meta property="og:site_name" content="Jimmy的日记">
<meta property="og:description" content="知识点
资源的并发访问控制
资源的多副本的并发访问控制
等待多个并发事件的完成
在集合点的同步
并发阶段任务的运行
并发阶段任务中的阶段切换
并发任务间的数据交换

介绍几个更高级的同步机制
信号量(Semaphore)：是一个计数器，用来保护一个或者多个共享资源的访问。
CountDownLatch：Java提供的同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许线程一直等待。
Cycl">
<meta property="og:updated_time" content="2016-10-31T06:00:21.181Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java多线程 0x03">
<meta name="twitter:description" content="知识点
资源的并发访问控制
资源的多副本的并发访问控制
等待多个并发事件的完成
在集合点的同步
并发阶段任务的运行
并发阶段任务中的阶段切换
并发任务间的数据交换

介绍几个更高级的同步机制
信号量(Semaphore)：是一个计数器，用来保护一个或者多个共享资源的访问。
CountDownLatch：Java提供的同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许线程一直等待。
Cycl">
  
    <link rel="alternate" href="/atom.xml" title="Jimmy的日记" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Jimmy的日记</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">study new skill step by step</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://JimmyYao984.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-一步一步精通Java多线程3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/09/一步一步精通Java多线程3/" class="article-date">
  <time datetime="2016-05-09T02:06:07.000Z" itemprop="datePublished">2016-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Java多线程 0x03
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><ul>
<li>资源的并发访问控制</li>
<li>资源的多副本的并发访问控制</li>
<li>等待多个并发事件的完成</li>
<li>在集合点的同步</li>
<li>并发阶段任务的运行</li>
<li>并发阶段任务中的阶段切换</li>
<li>并发任务间的数据交换<br><br><br></li>
</ul>
<h2 id="介绍几个更高级的同步机制"><a href="#介绍几个更高级的同步机制" class="headerlink" title="介绍几个更高级的同步机制"></a>介绍几个更高级的同步机制</h2><ul>
<li>信号量(Semaphore)：是一个计数器，用来保护一个或者多个共享资源的访问。</li>
<li>CountDownLatch：Java提供的同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许线程一直等待。</li>
<li>CyclicBarrier：Java同步辅助类，它允许多个线程在某个集合点(common point)处进行互相等待。</li>
<li>Phaser：Java同步辅助类，它把任务分成多个阶段运行，在开始下一个阶段之前，当前阶段内的所有线程都必须执行完成，这是JDK7中的新特性。</li>
<li>Exchanger：Java同步辅助类，它提供两个线程之间的数据交换点。<br><br> <br></li>
</ul>
<h2 id="二进制信号量（Binary-Semaphore）"><a href="#二进制信号量（Binary-Semaphore）" class="headerlink" title="二进制信号量（Binary Semaphore）"></a>二进制信号量（Binary Semaphore）</h2><p>信号量是一个计数器，用来保护一个或者多个共享资源的访问。<br>线程访问一个共享资源，必须先获得信号量。若信号量大于0，信号量减1，然后允许访问这个共享资源；否则，信号量已经是0，此时会把线程置入休眠等待信号量大于0。<br>线程访问完一个共享资源后，信号量必须释放，即将信号量加1。<br>二进制信号量(Binary Semaphore)是一种特殊的信号量，用来保护对唯一共享资源的访问。<br>创建PrintQueue类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintQueue</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PrintQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>); <span class="comment">//创建二进制信号量</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printJob</span><span class="params">(Object document)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            semaphore.acquire();</span><br><span class="line">            </span><br><span class="line">            Long duration = (<span class="keyword">long</span>)(Math.random() * <span class="number">10</span>);</span><br><span class="line">            System.out.printf(<span class="string">"%s: PrintQueue: Printing a Job during %d seconds\n"</span>, Thread.currentThread().getName(),duration);</span><br><span class="line">            TimeUnit.SECONDS.sleep(duration);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建Job类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PrintQueue printQueue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Job</span><span class="params">(PrintQueue printQueue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.printQueue = printQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"%s: Going to print a job\n"</span>,Thread.currentThread().getName());</span><br><span class="line">        printQueue.printJob(<span class="keyword">new</span> Object());</span><br><span class="line">        System.out.printf(<span class="string">"%s: The document has been printed\n"</span>, Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        PrintQueue printQueue = <span class="keyword">new</span> PrintQueue();</span><br><span class="line"></span><br><span class="line">        Thread thread[] = <span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">            thread[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Job(printQueue)，<span class="string">"Thread "</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    ｝</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取信号量的方法acquire()，释放信号量的方法release()。<br>Semaphore类还有其他两种acquire()方法。</p>
<ul>
<li>acquireUninterruptibly()：当信号量为0时，线程会被阻塞，可能会被中断，从而导致acquire()方法抛出InterruptedException异常。而acquireUninterruptibly()方法会忽略线程的中断并且不会抛出任何异常。</li>
<li>tryAcquire()：这个方法试图获取信号量，从而避开线程的阻塞和等待。<br>信号量的公平性，默认都是非公平性的，Semaphore类的构造函数也提供了boolean类型的模式选择。</li>
</ul>
<p><br><br></p>
<h2 id="信号量-Semaphore"><a href="#信号量-Semaphore" class="headerlink" title="信号量(Semaphore)"></a>信号量(Semaphore)</h2><p>信号量可以用来保护一个资源的多个副本，或者被多个线程同时执行的临界区。<br>创建PrintQueue类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintQueue</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> freePrinters[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Lock lockPrinters;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PrintQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</span><br><span class="line">        freePrinters = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">            freePrinters[i] = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lockPrinters = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printJob</span><span class="params">(Object document)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            semaphore.acquire();</span><br><span class="line">            <span class="keyword">int</span> assignedPrinter = getPrinter();</span><br><span class="line">            Long duration = (<span class="keyword">long</span>)(Math.random()*<span class="number">10</span>);</span><br><span class="line">			System.out.printf(<span class="string">"%s: PrintQueue: Printing a Job in Printer %d during %d seconds\n"</span>,Thread.currentThread().getName(),assignedPrinter,duration);</span><br><span class="line">			TimeUnit.SECONDS.sleep(duration);</span><br><span class="line"></span><br><span class="line">            freePrinters[assignedPrinter] = <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getPrinter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ret = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            lockPrinters.lock();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; freePrinters.length; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(freePrinters[i])&#123;</span><br><span class="line">                    ret = i;</span><br><span class="line">                    freePrinters[i] = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            lockPrinters.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建Job类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PrintQueue printQueue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Job</span><span class="params">(PrintQueue printQueue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.printQueue = printQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">		System.out.printf(<span class="string">"%s: Going to print a job\n"</span>,Thread.currentThread().getName());</span><br><span class="line">		printQueue.printJob(<span class="keyword">new</span> Object());</span><br><span class="line">		System.out.printf(<span class="string">"%s: The document has been printed\n"</span>,Thread.currentThread().getName());	</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        PrintQueue printQueue = <span class="keyword">new</span> PrintQueue();</span><br><span class="line">        Thread thread[] = <span class="keyword">new</span> Thread[<span class="number">12</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++)&#123;</span><br><span class="line">            thread[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Job(printQueue), <span class="string">"Thread "</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">12</span>; i++)&#123;</span><br><span class="line">            thread[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br><br></p>
<h2 id="等待多个并发事件的完成"><a href="#等待多个并发事件的完成" class="headerlink" title="等待多个并发事件的完成"></a>等待多个并发事件的完成</h2><p>Java并发API提供了CountDownLatch类，它是一个同步辅助类。<br>在完成一组正在其他线程中执行的操作之前，它允许线程一直等待。<br>这个类使用一个整数进行初始化，这个整数就是线程要等待完成的操作的数目。<br>当一个线程要等待某些操作先执行完时，需要调用await()方法，这个方法让线程进入休眠直到等待的所有操作都完成。<br>当某一个操作完成后，它将调用countDown()方法将CountDownLatch类的内部计数器减1。<br>当计数器变成0的时候，CountDownLatch类将唤醒所有调用await()方法而进入休眠的线程。</p>
<p>创建视频会议类Videoconference<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Videoconference</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch controller;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Videoconference</span><span class="params">(<span class="keyword">int</span> number)</span></span>&#123;</span><br><span class="line">        controller = <span class="keyword">new</span> CountDownLatch(number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">arrive</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"%s has arrived.\n"</span>,name);</span><br><span class="line">        controller.countDown();</span><br><span class="line">        System.out.printf(<span class="string">"VideoConference: Waiting for %d participants.\n"</span>, controller.getCount());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"VideoConference: Initialization: %d participants.\n"</span>, controller.getCount());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            controller.await();</span><br><span class="line">            System.out.printf(<span class="string">"VideoConference: All the participants have come\n"</span>);</span><br><span class="line">            System.out.printf(<span class="string">"VideoConference: Let's start...\n"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建与会者类Participant<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Videoconference conference;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">(Videoconference conference,String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conference = conference;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Long duration = (<span class="keyword">long</span>)(Math.random()*<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(duration);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        conference.arrive(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Videoconference conference = <span class="keyword">new</span> Videoconference(<span class="number">10</span>);</span><br><span class="line">        Thread threadConference = <span class="keyword">new</span> Thread(conference);</span><br><span class="line">        threadConference.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">            Participant p = <span class="keyword">new</span> Participant (conference, <span class="string">"Participant "</span> + i);</span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(p);</span><br><span class="line">            t.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CountDownLatch类有三个基本元素</p>
<ul>
<li>一个初始值，即定义必须等待的先行完成的操作的数目。</li>
<li>await()方法，需要等待其他事件完成的线程调用。</li>
<li>countDown()方法，每个被等待的事件在完成的时候调用。<br>创建CountDownLatch对象时，使用构造其来初始化内部计数器。当countDown()方法被调用后，计数器将减1。当计数器到达0的时候，CountDownLatch对象将唤起所有在await()方法上等待的线程。<br>CountDownLatch对象的内部计数器被初始化之后就不能被再次初始化或者修改。一旦计数器被初始化后，唯一能改变参数值的方法是countDown()方法。当计数器到达0时，所有因调用await()方法而等待的线程立即被唤醒，再执行countDown将不起任何作用。<br>和其他同步方法相比，CountDownLatch机制有下述不同：</li>
<li>CountDownLatch机制不是用来保护共享资源或者临界区的，它是同步执行多个任务的一个或者多个线程。</li>
<li>CountDownLatch只准许进入一次。即一旦CountDownLatch的内部计数器到达0，再调用这个方法将不起作用。<br>CountDownLatch类提供了另一种await()方法，即await(long time, TimeUnit unit)。这个方法被调用后，线程将休眠直到被中断，或者CountDownLatch的内部计数器达到0，或者指定的时间已经过期。<br>第二个参数是TimeUnit类型，TimeUnit类是以下常量的枚举值：DAYS\HOURS\MICROSECONDS\MILLISECONDS\MINUTES\NANOSECONDS\SECONDS。</li>
</ul>
<p><br><br></p>
<h2 id="在集合点的同步"><a href="#在集合点的同步" class="headerlink" title="在集合点的同步"></a>在集合点的同步</h2><p>Java并发API提供了CyclicBarrier类，它也是一个同步辅助类。<br>它允许两个或多个线程在某个点上进行同步。<br>这个类和CountDownLatch类类似，但也有不同之处，使之成为更强大的类。<br>CyclicBarrier类有一个很有意义的改进，可以传入另一个Runnable对象作为初始化参数。<br>当所有线程都到达集合点后，CyclicBarrier将这个Runnable对象作为线程执行。<br>这个特性使得这个类在并行任务上可以媲美分治编程技术（Divide and Conquer Programming Technique）。<br>创建MatrixMock类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MatrixMock</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> data[][]; <span class="comment">//二维数组data</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//矩阵的行数 每行的长度 寻找的数字</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MatrixMock</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> length, <span class="keyword">int</span> number)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="keyword">int</span>[size][length];</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ;i &lt; size; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; length; j++)&#123;</span><br><span class="line">                data[i][j] = random.nexInt(<span class="number">10</span>);</span><br><span class="line">                <span class="keyword">if</span>(data[i][j] == number)&#123;</span><br><span class="line">                    counter++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">"Mock: There are %d ocurrences of number in generated data.\n"</span>, counter, number);</span><br><span class="line">    ｝</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] getRow(<span class="keyword">int</span> row)&#123;</span><br><span class="line">        <span class="keyword">if</span>((row &gt;= <span class="number">0</span>) &amp;&amp; (row &lt; data.length))&#123;</span><br><span class="line">            <span class="keyword">return</span> data[row];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果类Results<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Results</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> data[];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Results</span><span class="params">(<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">int</span> position,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">        data[position] = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] getData()&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找类Searcher类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pubilc <span class="class"><span class="keyword">class</span> <span class="title">Searcher</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> firstRow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> lastRow;</span><br><span class="line">    <span class="keyword">private</span> MatrixMock mock;</span><br><span class="line">    <span class="keyword">private</span> Results results;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CyclicBarrier barrier;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Search</span><span class="params">(<span class="keyword">int</span> firstRow,<span class="keyword">int</span> lastRow,MatrixMock mock,Results results, <span class="keyword">int</span> number,CyclicBarrier barrier)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstRow = firstRow;</span><br><span class="line">        <span class="keyword">this</span>.lastRow = lastRow;</span><br><span class="line">        <span class="keyword">this</span>.mock = mock;</span><br><span class="line">        <span class="keyword">this</span>.results = results;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">        <span class="keyword">this</span>.barrier = barrier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> counter;</span><br><span class="line">        System.out.printf(<span class="string">"%s: Processing lines from %d to %d.\n"</span>, Thread.currentThread().getName(),firstRow, lastRow);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = firstRow; i &lt; lastRow; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> row[] = mock.getRow(i);</span><br><span class="line">            counter = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; row.length; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(row[j] == number)&#123;</span><br><span class="line">                    counter++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            results.setData(i, counter);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">"%s: Lines processed.\n"</span>,Thread.currentThread().getName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            barrier.await();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(BrokenBarrierException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建Grouper类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Grouper</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Results results;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Grouper</span><span class="params">(Results results)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.results = results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> finalResult = <span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">"Grouper: Processing results...\n"</span>);</span><br><span class="line">        <span class="keyword">int</span> data[] = results.getData();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> number : data)&#123;</span><br><span class="line">            finalResult += number;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">"Grouper: Total result: %d.\n"</span>,finalResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> ROWS = <span class="number">10000</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> NUMBERS = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> SEARCH = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> PARTICIPANTS = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> LINES_PARTICIPANT = <span class="number">2000</span>;</span><br><span class="line">        MatrixMock mock = <span class="keyword">new</span> MatrixMock(ROWS, NUMBERS, SEARCH);</span><br><span class="line">        Results results = <span class="keyword">new</span> Results(ROWS);</span><br><span class="line">        Grouper grouper = <span class="keyword">new</span> Grouper(results);</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(PARTICIPANTS, grouper);</span><br><span class="line">        Searcher searchers[] = <span class="keyword">new</span> Searcher[PARTICIPANTS];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PARTICIPANTS; i++)&#123;</span><br><span class="line">            searchers[i] = <span class="keyword">new</span> Searcher(i*LINES_PARTICIPANT, (i*LINES_PARTICIPANT)+LINES_PARTICIPANT, mock, results,<span class="number">5</span>, barrier);</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(searchers[i]);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">"Main: The main thread has finished.\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将矩阵分离成5个子集，并且在每个子集中使用线程进行查找，这些线程是查找类Searcher对象。<br>使用CyclicBarrier对象同步5个线程，执行Grouper查找任务处理结果，并且计算最终的结果。<br>CyclicBarrier类有一个内部计数器，可以控制指定数目的几个线程必须都到达集合点。<br>每一个线程到达集合点后就会调用await()方法通知CyclicBarrier对象，CyclicBarrier对象会让这个线程休眠直到其他所有的线程都到达集合点。<br>当所有线程都到达集合点之后，CyclicBarrier对象就唤醒所有的await()方法里等待的线程，同时，还可以以构造器传入的Runnable对象（Grouper对象）创建一个新的线程，以执行其他任务。<br>CyclicBarrier类还提供了getNumberWaiting()方法和getParties()方法，前者将返回在await()上阻塞的线程的数目，后者返回被CyclicBarrier对象同步的任务数。<br>CyclicBarrier类和CountDownLatch类不同，它可以重置回初始状态。<br>CyclicBarrier类提供了reset()方法完成的。当重置发生后，在await()方法中等待的线程将收到一个BrokenBarrierException异常。<br>CyclicBarrier对象有一种特殊的状态即损坏状态（Broken）。当很多线程在await()方法上等待的时候，如果其中一个线程被中断，这个线程将抛出InterruptedException异常，其他的等待线程将抛出BrokenBarrierException异常，于是CyclicBarrier对象就处于损坏状态了。<br>CyclicBarrier类提供了isBroken()方法，如果处于损坏状态就返回true，否则返回false。<br><br> <br></p>
<h2 id="并发阶段任务的运行"><a href="#并发阶段任务的运行" class="headerlink" title="并发阶段任务的运行"></a>并发阶段任务的运行</h2><p>Java API提供了一个更复杂、更强大的同步辅助类，Phaser，它允许执行并发多阶段任务。<br>当有并发任务并且需要分解成几步执行时，这种机制非常适用。<br>Phaser类机制是在每一步结束的位置对线程进行同步，当所有的线程都完成了这一步，才允许执行下一步。<br>跟其他同步工具一样，必须对Phaser类中参与同步操作的任务数进行初始化，不同的是，可以动态地增加或者减少任务数。<br>使用Phaser类同步三个并发任务，这三个任务将在三个不同的文件夹及其子文件夹中查找过去24小时内修改过扩展名的.log的文件。<br>这3个任务分成以下三个步骤：</p>
<ul>
<li>在指定的文件夹及其子文件夹中获得扩展名为.log的文件</li>
<li>对第一步的结果进行过滤，删除修改时间超过24小时的文件</li>
<li>将结果打印到控制台<br>在第一步和第二步结束的时候，都会检查所查找的结果列表是不是有元素存在。如果结果列表是空的 ，对应的线程将结束执行，并从phaser中删除。<br>创建FileSearch类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSearch</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String initPath;</span><br><span class="line">	<span class="keyword">private</span> String end;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; results;</span><br><span class="line">	<span class="keyword">private</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSearch</span><span class="params">(String initPath, String end, Phaser phaser)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.initPath = initPath;</span><br><span class="line">		<span class="keyword">this</span>.end = end;</span><br><span class="line">		<span class="keyword">this</span>.phaser = phaser;</span><br><span class="line">		results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">		phaser.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">		System.out.printf(<span class="string">"%s: Starting.\n"</span>, Thread.currentThread().getName());</span><br><span class="line"></span><br><span class="line">		File file = <span class="keyword">new</span> File(initPath);</span><br><span class="line">		<span class="keyword">if</span>(file.isDirectory())&#123;</span><br><span class="line">			directoryProcess(file);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!checkResults())&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		filterResults();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!checkResults())&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		showInfo();</span><br><span class="line">		phaser.arriveAndDeregister();</span><br><span class="line">		System.out.printf(<span class="string">"%s: Work completed.\n"</span>,Thread.currentThread().getName());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; results.size(); i++)&#123;</span><br><span class="line">			File file = <span class="keyword">new</span> File(results.get(i));</span><br><span class="line">			System.out.printf(<span class="string">"%s: %s\n"</span>, Thread.currentThread().getName(), file.getAbsolutePath());</span><br><span class="line">		&#125;</span><br><span class="line">		phaser.arriveAndAwaitAdvance();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查结果列表的长度</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkResults</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(results.isEmpty())&#123;</span><br><span class="line">			System.out.printf(<span class="string">"%s: Phase %d: 0 results.\n"</span>, Thread.currentThread().getName(), phaser.getPhase());</span><br><span class="line">			System.out.printf(<span class="string">"%s: Phase %d: End.\n"</span>, Thread.currentThread().getName(), phaser.getPhase());</span><br><span class="line">			phaser.arriveAndDeregister();<span class="comment">//调用Phaser对象当前线程已经结束这个阶段</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			System.out.printf(<span class="string">"%s: Phase %d: %d results.\n"</span>, Thread.currentThread().getName(), phaser.getPhase(), results.size());</span><br><span class="line">			phaser.arriveAndAwaitAdvance();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//对第一阶段查找到的文件列表进行过滤，将不是过去24小时修改的文件删除</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">filterResults</span><span class="params">()</span></span>&#123;</span><br><span class="line">		List&lt;String&gt; newResults = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">long</span> actualDate = <span class="keyword">new</span> Date().getTime();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; results.size(); i++)&#123;</span><br><span class="line">			File file = <span class="keyword">new</span> File(results.get(i));</span><br><span class="line">			<span class="keyword">long</span> fileDate = file.lastModified();</span><br><span class="line">			<span class="keyword">if</span>(actualDate - fileDate &lt;  TimeUnit.MILLISECONDS.convert(<span class="number">1</span>, TimeUnit.DAYS))&#123;</span><br><span class="line">				newResults.add(results.get(i));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		results = newResults;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//对每个文件夹递归调用</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">directoryProcess</span><span class="params">(File file)</span></span>&#123;</span><br><span class="line">		File list[] = file.listFiles();</span><br><span class="line">		<span class="keyword">if</span>(list != <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.length; i++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(list[i].isDirectory())&#123;</span><br><span class="line">					directoryProcess(list[i]);</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					fileProcess(list[i]);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fileProcess</span><span class="params">(File file)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(file.getName().endsWith(end))&#123;</span><br><span class="line">			results.add(file.getAbsolutePath());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		Phaser phaser = <span class="keyword">new</span> Phaser(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">		FileSearch system  = <span class="keyword">new</span> FileSearch(<span class="string">"C:\\XXX"</span>, <span class="string">"log"</span>, phaser);</span><br><span class="line">		FileSearch apps = <span class="keyword">new</span> FileSearch(<span class="string">"C:\\XXXX"</span>, <span class="string">"log"</span>, phaser);</span><br><span class="line">		FileSearch documents = <span class="keyword">new</span> FileSearch(<span class="string">"C:\\XXXXX"</span>,<span class="string">"log"</span>, phaser);</span><br><span class="line"></span><br><span class="line">		Thread systemThread = <span class="keyword">new</span> Thread(system, <span class="string">"System"</span>);</span><br><span class="line">		systemThread.start();</span><br><span class="line"></span><br><span class="line">		Thread appsThread = <span class="keyword">new</span> Thread(apps, <span class="string">"Apps"</span>);</span><br><span class="line">		appsThread.start();</span><br><span class="line"></span><br><span class="line">		Thread documentsThread = <span class="keyword">new</span> Thread(documents, <span class="string">"Documents"</span>);</span><br><span class="line">		documentsThread.start();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			systemThread.join();</span><br><span class="line">			appsThread.join();</span><br><span class="line">			documentsThread.join();</span><br><span class="line">		&#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.printf(<span class="string">"Terminated: %s\n"</span>, phaser.isTerminated());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>开始时候创建Phaser对象，用于在每个阶段结束时对线程同步进行控制。Phaser构造器传入了参与阶段同步的线程的个数。<br>这个数字通知Phaser在唤醒所有休眠线程以进行下一个阶段之前，必须执行arriveAndAwaitAdvance()方法的线程数。<br>在run()方法开头调用arriveAndAwaitAdvanced这个方法可以保障在所有线程创建好之前没有线程开始执行任务。（同一起跑线）<br>在第一阶段和第二阶段结束的时候，检查这个阶段中是不是生成了结果集以及结果集中是不是有元素。<br>在第一阶段,checkResults()方法里调用arriveAndAwaitAdvance()方法。<br>在第二阶段，如果结果集是空的，对应线程没有理由继续执行，所以返回；但必须通知phaser对象参与同步的线程少了一个，调用arriverAndDeregister()方法。<br>在第三阶段结束的时候，在showInfo()方法中调用了phaser对下你给的arriveAndAwaitAdvance()方法，通过这个调用，确保三个线程都已完成。<br>当showInfo()方法执行完成之后，还调用了phaser对象的arriveAndDeregiester()方法，通过这个调用，撤销phaser中线程的注册。<br>一个Phaser对象有两种状态</p>
<ul>
<li>活跃态(Active)：当存在参与同步的线程时，Phaser就是活跃态，并且在每个阶段结束的时候进行同步。</li>
<li>终止态（Termination）：当所有参与同步的线程都取消注册的时候，Phaser就处于终止状态，在这种状态下，Phaser没有任何参与者。<br>当Phaser对象的onAdvance()方法返回true的时候，Phaser对象就处于终止态。<br>当Phaser是终止态是，同步方法arriveAndAwaitAdvance()会立即返回，而且不会做任何同步的操作。<br>Phaser类的一个重大特性就是不必对它的方法进行异常处理。不像其他的同步辅助类，被Phaser类置于休眠的线程不会影响中断事件，也不会抛出InterruptException异常。<br><br><br>Phaser类提供了其他改变Phaser对象的方法</li>
<li>arrive()：这个方法通知phaser对象一个参与者已经完成了当前阶段，但是它不应该等待其他参与者都完成当前阶段。必须小心使用这个方法，因为它不会与其他线程同步。</li>
<li>awaitAdvance(int phaser)：如果传入的阶段参数与当前阶段一直，这个方法会将当前线程置于休眠，直到这个阶段所有参与者都运行完成。如果传入的阶段参数与当前阶段不一致，这个方法将立即返回。</li>
<li>awaitAdvanceInterruptibly(int phaser)：这个方法根awaitAdvance(int phase)一样，不同之处是如果在这个方法中休眠的线程被中断，它将抛出InterruptedException异常。<br><br><br>创建一个Phaser对象时，需要指出有多少个参与者。Phaser类提供两种方法增加注册者的数量。</li>
<li>register()：这个方法将一个新的参与者注册到Phaser中，这个新的参与者将被当成没有执行完本阶段的线程。</li>
<li>bulkRegister(int Parties):这个方法将指定数目的参与者注册到Phaser中，所有这些新的参与者都将被当成没有执行完本阶段的线程。<br><br><br>Phaser类提供了forceTermination()方法来强制phaser进入终止态，这个方法不管phaser中是否存在注册的参与线程。当一个参与线程产生错误时，强制phaser终止时很有意义的。<br>当一个phaser处于终止态时，awaitAdvance()和arriveAndAwaitAdvance()方法立即返回一个负数，而不再是一个正值了。如果知道phaser可能会被终止，就需要验证这些方法的返回值，以确定phaser是不是被终止了。</li>
</ul>
<p><br> <br></p>
<h2 id="并发阶段任务中的阶段切换"><a href="#并发阶段任务中的阶段切换" class="headerlink" title="并发阶段任务中的阶段切换"></a>并发阶段任务中的阶段切换</h2><p>Phaser类提供了onAdvance()方法，它在phaser阶段改变的时候会被自动执行。<br>onAdvance()方法需要两个int型的传入参数：当前的阶段数以及注册的参与者数量。<br>它返回的是boolean值，true表示已经完成执行并进入终止态，false表示phaser还在继续执行。<br>创建MyPhaser类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPhaser</span> <span class="keyword">extends</span> <span class="title">Phaser</span></span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAdvance</span><span class="params">(<span class="keyword">int</span> phase, <span class="keyword">int</span> registeredParties)</span></span>&#123;</span><br><span class="line">		<span class="keyword">switch</span>(phase)&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">return</span> studentsArrived();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				<span class="keyword">return</span> finishFirstExercise();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				<span class="keyword">return</span> finishSecondExercise();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				<span class="keyword">return</span> finishExam();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">studentsArrived</span><span class="params">()</span></span>&#123;</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: The exam are going to start. The students are ready.\n"</span>);</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: We have %d students.\n"</span>,getRegisteredParties());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">finishFirstExercise</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: All the students has finished the first exercise.\n"</span>);</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: It's turn for the second one.\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">finishSecondExercise</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: All the students has finished the second exercise.\n"</span>);</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: It's turn for the third one.\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">finishExam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: All the students has finished the exam.\n"</span>);</span><br><span class="line">		System.out.printf(<span class="string">"Phaser: Thank you for your time.\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建Student类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(Phaser phaser)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.phaser = phaser;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">		System.out.printf(<span class="string">"%s: Has arrived to do the exam. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		phaser.arriveAndAwaitAdvance();</span><br><span class="line">		System.out.printf(<span class="string">"%s: Is going to do the first exercise. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		doExercise1();</span><br><span class="line"></span><br><span class="line">		System.out.printf(<span class="string">"%s: Has done the first exercise. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		phaser.arriveAndAwaitAdvance();</span><br><span class="line">		System.out.printf(<span class="string">"%s: Is going to do the second exercise. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		doExercise2();</span><br><span class="line"></span><br><span class="line">		System.out.printf(<span class="string">"%s: Has done the second exercise. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		phaser.arriveAndAwaitAdvance();</span><br><span class="line">		System.out.printf(<span class="string">"%s: Is going to do the third exercise. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		doExercise3();</span><br><span class="line">		System.out.printf(<span class="string">"%s: Has finished the exam. %s\n"</span>,Thread.currentThread().getName(),<span class="keyword">new</span> Date());</span><br><span class="line">		phaser.arriveAndAwaitAdvance();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExercise1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Long duration=(<span class="keyword">long</span>)(Math.random()*<span class="number">10</span>);</span><br><span class="line">			TimeUnit.SECONDS.sleep(duration);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExercise2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Long duration=(<span class="keyword">long</span>)(Math.random()*<span class="number">10</span>);</span><br><span class="line">			TimeUnit.SECONDS.sleep(duration);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExercise3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Long duration=(<span class="keyword">long</span>)(Math.random()*<span class="number">10</span>);</span><br><span class="line">			TimeUnit.SECONDS.sleep(duration);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		MyPhaser phaser=<span class="keyword">new</span> MyPhaser();</span><br><span class="line"></span><br><span class="line">		Student students[]=<span class="keyword">new</span> Student[<span class="number">5</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;students.length; i++)&#123;</span><br><span class="line">			students[i]=<span class="keyword">new</span> Student(phaser);</span><br><span class="line">			phaser.register();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Thread threads[]=<span class="keyword">new</span> Thread[students.length];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;students.length; i++) &#123;</span><br><span class="line">			threads[i]=<span class="keyword">new</span> Thread(students[i],<span class="string">"Student "</span>+i);</span><br><span class="line">			threads[i].start();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;threads.length; i++) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				threads[i].join();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		System.out.printf(<span class="string">"Main: The phaser has finished: %s.\n"</span>,phaser.isTerminated());</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>模拟了有三道试题的考试过程。所有的学生做完第一道题才开始做第二道。<br>phaser对象进行阶段切换的时候，在所有arriveAndAwaitAdvance()方法里休眠的线程被唤醒之前，onAdvance()方法将被自动调用。</p>
<p><br> <br></p>
<h2 id="并发任务间的数据交换"><a href="#并发任务间的数据交换" class="headerlink" title="并发任务间的数据交换"></a>并发任务间的数据交换</h2><p>Java并发API提供了Exchanger来实心并发任务之间交换数据。<br>Exchanger类允许在两个线程之间定义同步点（Synchronization Point）。当两个线程都到达同步点时，它们交换数据结构，因此第一个线程的数据结构进入到第二个线程中，同时第二个线程的数据结构进入到第一个线程中。<br>Exchanger类在生产者——消费者中很有用，但Exchanger只能同步两个线程，即一个线程生产者，一个线程消费者。<br>创建Producer类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; buffer;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Exchanger&lt;List&lt;String&gt;&gt; exchanger;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(List&lt;String&gt; buffer, Exchanger&lt;List&lt;String&gt;&gt; exchanger)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.buffer = buffer;</span><br><span class="line">		<span class="keyword">this</span>.exchanger = exchanger;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> cycle = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i  &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">			System.out.printf(<span class="string">"Producer: Cycle %d\n"</span>, cycle);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++)&#123;</span><br><span class="line">				String message = <span class="string">"Event "</span> + ((i*<span class="number">10</span>) + j);</span><br><span class="line">				System.out.printf(<span class="string">"Producer: %s\n"</span>, message);</span><br><span class="line">				buffer.add(message);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">try</span>&#123;</span><br><span class="line">				buffer = exchanger.exchange(buffer);</span><br><span class="line">			&#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			System.out.printf(<span class="string">"Producer: %d\n"</span>, buffer.size());</span><br><span class="line">			cycle++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建Consumer类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; buffer;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Exchanger&lt;List&lt;String&gt;&gt; exchanger;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(List&lt;String&gt; buffer, Exchanger&lt;List&lt;String&gt;&gt; exchanger)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.buffer = buffer;</span><br><span class="line">		<span class="keyword">this</span>.exchanger = exchanger;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> cycle = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">			System.out.printf(<span class="string">"Consumer: Cycle %d\n"</span>, cycle);</span><br><span class="line">			<span class="keyword">try</span>&#123;</span><br><span class="line">				buffer = exchanger.exchange(buffer);</span><br><span class="line">			&#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.printf(<span class="string">"Consumer: %d\n"</span>, buffer.size());</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++)&#123;</span><br><span class="line">				String message = buffer.get(<span class="number">0</span>);</span><br><span class="line">				System.out.printf(<span class="string">"Consumer: %s\n"</span>, message);</span><br><span class="line">				buffer.remove(<span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			cycle++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		List&lt;String&gt; buffer1 = <span class="keyword">new</span> ArrayList();</span><br><span class="line">		List&lt;String&gt; buffer2 = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">		Exchanger&lt;List&lt;String&gt;&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		Producer producer = <span class="keyword">new</span> Producer(buffer1, exchanger);</span><br><span class="line">		Consumer consumer = <span class="keyword">new</span> Consumer(buffer2, exchanger);</span><br><span class="line"></span><br><span class="line">		Thread threadProducer = <span class="keyword">new</span> Thread(producer);</span><br><span class="line">		Thread threadConsumer = <span class="keyword">new</span> Thread(consumer);</span><br><span class="line"></span><br><span class="line">		threadProducer.start();</span><br><span class="line">		threadConsumer.start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>消费者先创建一个空的缓存列表，然后通过调用Exchanger与生产者同步来获得可以消费的数据。生产者从一个空的缓存列表开始执行，它创建了10个字符串，然后存储在这个缓存中，并且使用exchanger队形与消费者同步。</p>
<p>Exchanger类还提供了另外的exchanger方法，即exchange(V data, long time, TimeUnit unit)方法。<br>V指要交换的数据结构<br>time指定等待的time值<br>TimeUnit可以是DAYS\HOURS\MICROSECONDS\MILLISECONDS\MINUTES\NANOSECONDS\SECONDS</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://JimmyYao984.github.io/2016/05/09/一步一步精通Java多线程3/" data-id="civ9ktzly000ejogfe5lbdqpc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/13/一步一步精通Java多线程4/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Java多线程 0x04
        
      </div>
    </a>
  
  
    <a href="/2016/05/04/一步一步精通Java多线程2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Java多线程 0x02</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/16/安全加密认证基础知识/">安全加密认证基础知识</a>
          </li>
        
          <li>
            <a href="/2016/09/13/RX前传/">RX前传</a>
          </li>
        
          <li>
            <a href="/2016/08/08/源码分析OKHttp/">源码分析OKHttp</a>
          </li>
        
          <li>
            <a href="/2016/08/05/doc-ppt-online/">在线预览ppt doc</a>
          </li>
        
          <li>
            <a href="/2016/07/21/Java注解/">Java注解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Jimmy Yao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>